<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SquareYards Property Listing Chatbot</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
        /* Removed transform and opacity transitions for #chatbot-window */
        *,::before,::after{-webkit-box-sizing:border-box;-moz-box-sizing:border-box;box-sizing:border-box;outline:none}
        body{font-family:'Poppins',sans-serif;margin:0;background-color:#f4f4f4}
        body,ul,ol,li,h1,h2,h3,h4,h5,h6,figure,p,strong{padding:0;margin:0;list-style:none}
        #chatbot-icon{position:fixed;bottom:20px;right:20px;width:60px;height:60px;background:linear-gradient(135deg,#333,#555);border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:0 4px 8px #0000004d;z-index:1000;transition:transform 0.3s ease;animation:pulse 2s infinite ease-in-out}
        #chatbot-icon::before{font-size:24px;color:#fff}
        #chatbot-icon.closed::before{content:'ðŸ’¬'}
        #chatbot-icon.open::before{content:'â–¼'}
        #chatbot-icon:hover{animation:bounce 0.4s ease}
        #chatbot-icon:focus{outline:2px solid #7be0b6}
        @keyframes pulse {
            0%, 100% {transform:scale(1);box-shadow:0 4px 8px #0000004d}
            50% {transform:scale(1.05);box-shadow:0 6px 12px #00000066}
        }
        @keyframes bounce {
            0%, 100% {transform:scale(1)}
            50% {transform:scale(1.2)}
        }
        .chatbot-popup{position:fixed;bottom:90px;right:30px;background:linear-gradient(135deg,#7be0b6,#4a9c7a);color:#fff;padding:10px 15px;border-radius:10px;box-shadow:0 3px 6px #0000004d;font-size:12px;font-weight:500;cursor:pointer;text-shadow:0 1px 1px #00000033;display:none;z-index:999;opacity:0;transform:translateY(15px) scale(0.8);transition:opacity 0.4s ease, transform 0.4s cubic-bezier(0.68, -0.55, 0.27, 1.55)}
        .chatbot-popup.show{opacity:1;transform:translateY(0) scale(1);display:block}
        .chatbot-popup:not(.show){opacity:0;transform:translateY(10px) scale(0.9)}
        .chatbot-popup::after{content:'';position:absolute;bottom:-6px;right:10px;border-left:6px solid transparent;border-right:6px solid transparent;border-top:6px solid #7be0b6}
        .chatbot-popup:hover{transform:scale(1.05);box-shadow:0 0 0 3px #7be0b633,0 3px 6px #0000004d}
        .chatbot-popup:focus{outline:2px solid #fff;outline-offset:2px}
        @media (max-width: 600px) {
            .chatbot-popup{right:10px;font-size:11px;padding:8px 12px}
        }
        /* #chatbot-window{position:fixed;bottom:80px;right:80px;width:375px;max-height:488px;background:linear-gradient(145deg,#fff,#f7f7f7);border-radius:50px;box-shadow:0 6px 12px #0003;display:none;flex-direction:column;z-index:1000} */
        #chatbot-window{position:fixed;bottom:65px;right:85px;width:375px;background-color:#fff;border-radius:10px;box-shadow:0 4px 10px #0003;display:none;flex-direction:column;z-index:1000}
        #chatbot-window.open{display:flex}
        #chatbot-window.dark-mode{background:linear-gradient(145deg,#2a2a2a,#333);color:#fff}
        @media (max-width: 600px) {
            #chatbot-window{width:100%;max-height:100%;bottom:0;right:0;border-radius:0}
        }
        .chatbot-header{padding:15px;height:78px;border-radius:12px 12px 0 0;display:flex;gap:10px;background:linear-gradient(135deg,#333,#555);align-items:center}
        .chatbot-header .company-profile{display:flex;flex-direction:column;gap:8px}
        .chatbot-header .company-profile p{font-size:15px;color:#fff;line-height:16px;font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:200px}
        .chatbot-header .company-profile span{font-size:14px;color:#7be0b6}
        .chatbot-header .close-btn{position:absolute;top:15px;right:70px;background:none;border:none;color:#fff;font-size:24px;font-weight:700;transition:color 0.2s ease, transform 0.2s ease;cursor:pointer}
        .chatbot-header .close-btn:hover{color:#f0f0f0;transform:scale(1.1)}
        .chatbot-header .close-btn:focus{outline:2px solid #7be0b6}
        .theme-toggle{position:absolute;top:15px;right:40px;background:none;border:none;color:#fff;font-size:18px;cursor:pointer;transition:transform 0.2s ease}
        .theme-toggle:hover{transform:scale(1.1)}
        .theme-toggle:focus{outline:2px solid #7be0b6}
        .animation-toggle{position:absolute;top:15px;right:10px;background:none;border:none;color:#fff;font-size:18px;cursor:pointer;transition:transform 0.2s ease}
        .animation-toggle:hover{transform:scale(1.1)}
        .animation-toggle:focus{outline:2px solid #7be0b6}
        .chatbot-body{flex:1;padding:15px;overflow-y:auto;background:#f7f4ff;max-height:300px}
        .chatbot-body.dark-mode{background:#222}
        .chatbot-body::-webkit-scrollbar{width:8px}
        .chatbot-body::-webkit-scrollbar-thumb{background-color:#333;border-radius:4px}
        .chatbot-body::-webkit-scrollbar-track{background-color:#f1f1f1}
        .message{margin:10px 0;max-width:80%;font-size:14px;opacity:0;transform:translateY(10px);animation:fadeIn 0.3s ease forwards}
        .typing-indicator{padding:12px;border-radius:0 20px 20px 20px;background:#fff;display:flex;align-items:center;gap:8px;animation:pulseTyping 1.8s infinite ease-in-out;box-shadow:0 2px 4px rgba(0,0,0,0.1)}
        .typing-indicator.dark-mode{background:#444;box-shadow:0 2px 4px rgba(0,0,0,0.3)}
        .typing-indicator.bouncing-dots .dot{width:10px;height:10px;background:#7be0b6;border-radius:50%;animation:dotPulse 1.4s infinite ease-in-out}
        .typing-indicator.bouncing-dots.dark-mode .dot{background:#7be0b6}
        .typing-indicator.bouncing-dots .dot:nth-child(1){animation-delay:0s}
        .typing-indicator.bouncing-dots .dot:nth-child(2){animation-delay:0.2s}
        .typing-indicator.bouncing-dots .dot:nth-child(3){animation-delay:0.4s}
        @keyframes dotPulse {
            0%, 80%, 100% {transform:scale(1) translateY(0);opacity:0.6}
            40% {transform:scale(1.6) translateY(-2px);opacity:1;box-shadow:0 0 8px rgba(123,224,182,0.5)}
        }
        .typing-indicator.horizontal-wave .dot{width:10px;height:10px;background:#7be0b6;border-radius:50%;animation:wavePulse 1.6s infinite ease-in-out}
        .typing-indicator.horizontal-wave.dark-mode .dot{background:#7be0b6}
        .typing-indicator.horizontal-wave .dot:nth-child(1){animation-delay:0s}
        .typing-indicator.horizontal-wave .dot:nth-child(2){animation-delay:0.3s}
        .typing-indicator.horizontal-wave .dot:nth-child(3){animation-delay:0.6s}
        @keyframes wavePulse {
            0%, 100% {transform:translateX(0);opacity:0.5}
            50% {transform:translateX(8px);opacity:1;box-shadow:0 0 6px rgba(123,224,182,0.4)}
        }
        .typing-indicator.rotating-squares .dot{width:10px;height:10px;background:#7be0b6;border-radius:2px;animation:squareRotate 1.5s infinite ease-in-out}
        .typing-indicator.rotating-squares.dark-mode .dot{background:#7be0b6}
        .typing-indicator.rotating-squares .dot:nth-child(1){animation-delay:0s}
        .typing-indicator.rotating-squares .dot:nth-child(2){animation-delay:0.25s}
        .typing-indicator.rotating-squares .dot:nth-child(3){animation-delay:0.5s}
        @keyframes squareRotate {
            0% {transform:rotate(0deg) scale(1);opacity:0.6}
            50% {transform:rotate(180deg) scale(1.4);opacity:1;box-shadow:0 0 6px rgba(123,224,182,0.4)}
            100% {transform:rotate(360deg) scale(1);opacity:0.6}
        }
        @keyframes pulseTyping {
            0%, 100% {transform:scale(1);opacity:0.9}
            50% {transform:scale(1.03);opacity:1}
        }
        @keyframes fadeIn {
            to {opacity:1;transform:translateY(0)}
        }
        @media (max-width: 600px) {
            .message{font-size:12px}
            .typing-indicator{padding:8px;gap:6px}
            .typing-indicator .dot{width:8px;height:8px}
            .typing-indicator.rotating-squares .dot{width:8px;height:8px}
        }
        .bot-message{padding:15px 20px;background:#fff;border-radius:0 20px 20px 20px;display:inline-flex;flex-direction:column;gap:14px;color:#333}
        .bot-message.dark-mode{background:#444;color:#fff}
        .user-message{background:linear-gradient(135deg,#333,#555);color:#fff;font-weight:700;padding:10px;border-radius:10px 10px 0 10px;margin-left:auto}
        .selected-option{background:linear-gradient(135deg,#333,#555);font-weight:700;border:1px solid #333;padding:8px 12px}
        .reminder-message{background-color:#fff3cd;color:#856404;padding:15px 20px;font-style:italic;border-radius:0 20px 20px 20px}
        .reminder-message.dark-mode{background:#4b3b1b;color:#ffeb3b}
        .chatbot-input{padding:10px 10px 20px;border-top:1px solid #ddd;background:#fff;border-radius:0 0 12px 12px}
        .chatbot-input.dark-mode{background:#2a2a2a;border-top-color:#444}
        .input-wrapper{position:relative;display:flex;align-items:center}
        .input-wrapper input{width:100%;padding:8px 40px 8px 10px;border:1px solid #ccc;border-radius:5px;font-size:14px;box-sizing:border-box;transition:border-color 0.2s ease}
        .input-wrapper input:focus{outline:none;border-color:#7be0b6}
        .input-wrapper input:focus + .submit-arrow{background:#7be0b6;color:#fff}
        .input-wrapper input:valid:not(:placeholder-shown){border-color:#2e7d32}
        .input-wrapper input:invalid:not(:placeholder-shown){border-color:#d32f2f}
        .input-wrapper input.dark-mode{background:#333;color:#fff;border-color:#555}
        .input-wrapper .submit-arrow{position:absolute;right:5px;top:50%;transform:translateY(-50%);color:#333;font-size:18px;cursor:pointer;background:#f0f0f0;width:30px;height:30px;border-radius:5px;display:flex;align-items:center;justify-content:center;transition:background-color 0.2s ease, transform 0.2s ease}
        .input-wrapper .submit-arrow:hover{background:#e0e0e0;transform:scale(1.1) translateY(-50%)}
        .input-wrapper input:focus::after{content:'Press Enter';position:absolute;bottom:2px;right:45px;font-size:10px;color:#7be0b6;font-style:italic}
        @media (max-width: 600px) {
            .input-wrapper input{font-size:12px}
            .input-wrapper input:focus::after{font-size:9px}
        }
        .otp-container{display:flex;gap:7px;justify-content:center;margin-bottom:1px}
        .otp-input{width:35px;height:35px;text-align:center;font-size:14px;border:1px solid #ccc;border-radius:5px;transition:border-color 0.2s ease, box-shadow 0.2s ease}
        .otp-input:focus{outline:none;border-color:#7be0b6;box-shadow:0 0 5px rgba(123,224,182,0.5)}
        .otp-input:valid{border-color:#2e7d32}
        .otp-input:invalid:not(:placeholder-shown){border-color:#d32f2f}
        .otp-input.dark-mode{background:#333;color:#fff;border-color:#555}
        .otp-resend{display:flex;flex-direction:column;align-items:center;margin-top:8px}
        .otp-resend button{padding:8px 16px;border:none;border-radius:4px;background:#ccc;color:#fff;cursor:not-allowed;font-size:13px;transition:background 0.2s ease, transform 0.2s ease, opacity 0.2s ease}
        .otp-resend button.enabled{background:linear-gradient(135deg,#7be0b6,#4a9c7a);cursor:pointer}
        .otp-resend button.enabled:hover{transform:scale(1.05)}
        .otp-resend button:focus{outline:1px solid #7be0b6}
        .otp-timer{font-size:12px;color:#333;margin-bottom:5px;display:flex;justify-content:center}
        .otp-timer.dark-mode{color:#fff}
        .autocomplete-dropdown{position:absolute;top:100%;left:0;width:100%;max-height:150px;overflow-y:auto;background:#fff;border:1px solid #ccc;border-radius:5px;box-shadow:0 2px 5px #0000001a;z-index:1001;display:none;transform-origin:top;transform:scaleY(0);transition:transform 0.2s ease}
        .autocomplete-dropdown.active{transform:scaleY(1);display:block}
        .autocomplete-dropdown.dark-mode{background:#333;border-color:#555}
        .autocomplete-dropdown .autocomplete-item{padding:8px 10px;cursor:pointer;font-size:14px;color:#333;transition:background-color 0.2s ease}
        .autocomplete-dropdown .autocomplete-item:hover,.autocomplete-item.active{background:#e6f0fa}
        .autocomplete-dropdown.dark-mode .autocomplete-item{color:#fff}
        .autocomplete-dropdown.dark-mode .autocomplete-item:hover,.autocomplete-dropdown.dark-mode .autocomplete-item.active{background:#444}
        .autocomplete-dropdown::-webkit-scrollbar{width:6px}
        .autocomplete-dropdown::-webkit-scrollbar-thumb{background-color:#333;border-radius:3px}
        .autocomplete-dropdown::-webkit-scrollbar-track{background-color:#f1f1f1}
        .chatbot-input .buttons{display:flex;gap:10px;margin-top:10px}
        .chatbot-input button{flex:1;padding:10px;border:none;border-radius:5px;background:linear-gradient(135deg,#333,#555);color:#fff;cursor:pointer;font-size:14px;transition:transform 0.2s ease}
        .chatbot-input .default{background:#fff;color:#333;border:1px solid #333}
        .chatbot-input button:hover{transform:scale(1.05)}
        .chatbot-input button:focus{outline:2px solid #7be0b6}
        @media (max-width: 600px) {
            .chatbot-input button{font-size:12px}
        }
        .chatbot-input button.secondary{background:linear-gradient(135deg,#555,#777);color:#fff}
        .chatbot-input .clear-chat-btn{display:block;width:100%;padding:10px;border:none;border-radius:5px;background:#ff4d4d;color:#fff;cursor:pointer;font-size:14px;text-align:center;transition:transform 0.2s ease}
        .chatbot-input .clear-chat-btn:hover{transform:scale(1.05)}
        .chatbot-input .clear-chat-btn:focus{outline:2px solid #7be0b6}
        @media (max-width: 600px) {
            .chatbot-input .clear-chat-btn{font-size:12px}
        }
        .error-message{color:#d32f2f;font-size:11px;margin-top:5px;opacity:0;animation:fadeIn 0.3s ease forwards}
        .final-message-container{display:flex;align-items:center;background:#e6f7fa;border:1px solid #b3e5fc;border-radius:8px;padding:10px;margin-top:10px;font-size:14px;color:#333}
        .final-message-container.dark-mode{background:#2e4b5e;border-color:#4b6b7d;color:#fff}
        @media (max-width: 600px) {
            .final-message-container{font-size:12px}
        }
        .final-message-container img.agent-image{width:40px;height:40px;border-radius:50%;margin-right:10px}
        .online-status{display:flex;align-items:center;font-size:12px;color:#2e7d32;margin-bottom:5px}
        .online-status.dark-mode{color:#7be0b6}
        @media (max-width: 600px) {
            .online-status{font-size:10px}
        }
        .online-dot{width:10px;height:10px;background-color:#2e7d32;border-radius:50%;margin-right:5px}
        .online-dot.dark-mode{background-color:#7be0b6}
    </style>
</head>
<body>
    <div id="chatbot-icon" role="button" aria-label="Open chatbot" tabindex="0"></div>
    <div class="chatbot-popup" role="button" aria-label="List your property" tabindex="0" aria-hidden="true"></div>
    <div id="chatbot-window" role="dialog" aria-label="Property Listing Chatbot">
        <div class="chatbot-header">
            <figure><img class="img-responsive" src="assets/images/bot-icon-white.svg" alt="SquareYards bot icon"></figure>
            <div class="company-profile">
                <p>Property Listing Assistant</p>
                <span class="status">Online</span>
            </div>
            <button class="close-btn" aria-label="Close chatbot">Ã—</button>
            <button class="theme-toggle" aria-label="Toggle theme">ðŸŒ™</button>
            <button class="animation-toggle" aria-label="Change typing animation">ðŸ”„</button>
        </div>
        <div class="chatbot-body" id="chatbot-body" role="log" aria-live="polite"></div>
        <div class="chatbot-input" id="chatbot-input"></div>
    </div>

    <script>
        let cityList = [];
        let cityListFetched = false;
        let popupInterval = null;
        let currentAnimationStyle = 'bouncing-dots';
        const animationStyles = ['bouncing-dots', 'horizontal-wave', 'rotating-squares'];
        const popupMessages = [
            "List Your Property Fast!",
            "Sell or Rent in Minutes!",
            "Get Started with SquareYards!",
            "Post Your Listing Now!",
            "Find Buyers or Tenants Today!"
        ];

        const state = {
            step: 0,
            data: {
                userType: '',
                listingType: '',
                city: '',
                name: '',
                number: '',
                otp: ''
            },
            hasStarted: false,
            reminderTimeout: null,
            reminderShown: false,
            isOtpSent: false,
            otpAttempts: 0,
            maxOtpAttempts: 3,
            otpSentTime: null,
            otpValidDuration: 300000,
            resendCooldown: 30000,
            lastOtpSent: null,
            timerInterval: null,
            isLeadSubmitted: false
        };

        const chatbotIcon = document.getElementById('chatbot-icon');
        const chatbotPopup = document.querySelector('.chatbot-popup');
        const chatbotWindow = document.getElementById('chatbot-window');
        const chatbotBody = document.getElementById('chatbot-body');
        const chatbotInput = document.getElementById('chatbot-input');
        const closeBtn = document.querySelector('.close-btn');
        const themeToggle = document.querySelector('.theme-toggle');
        const animationToggle = document.querySelector('.animation-toggle');

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showPopupMessage() {
            if (!chatbotIcon.classList.contains('closed')) {
                chatbotPopup.classList.remove('show');
                chatbotPopup.setAttribute('aria-hidden', 'true');
                return;
            }
            const randomMessage = popupMessages[Math.floor(Math.random() * popupMessages.length)];
            chatbotPopup.textContent = randomMessage;
            chatbotPopup.setAttribute('aria-label', randomMessage);
            chatbotPopup.setAttribute('aria-hidden', 'false');
            chatbotPopup.classList.add('show');
            setTimeout(() => {
                chatbotPopup.classList.remove('show');
                chatbotPopup.setAttribute('aria-hidden', 'true');
            }, 6000);
        }

        function startPopupInterval() {
            showPopupMessage();
            popupInterval = setInterval(showPopupMessage, 12000);
        }

        function stopPopupInterval() {
            clearInterval(popupInterval);
            chatbotPopup.classList.remove('show');
            chatbotPopup.setAttribute('aria-hidden', 'true');
        }

        themeToggle.addEventListener('click', () => {
            const isDarkMode = chatbotWindow.classList.toggle('dark-mode');
            chatbotBody.classList.toggle('dark-mode');
            chatbotInput.classList.toggle('dark-mode');
            themeToggle.textContent = isDarkMode ? 'â˜€ï¸' : 'ðŸŒ™';
            document.querySelectorAll('.bot-message, .typing-indicator, .reminder-message, .final-message-container, .online-status, .online-dot, .input-wrapper input, .otp-input, .otp-timer').forEach(item => {
                item.classList.toggle('dark-mode', isDarkMode);
            });
        });

        animationToggle.addEventListener('click', () => {
            const currentIndex = animationStyles.indexOf(currentAnimationStyle);
            currentAnimationStyle = animationStyles[(currentIndex + 1) % animationStyles.length];
            removeTypingIndicator();
            showTypingIndicator();
            setTimeout(removeTypingIndicator, 1000);
        });

        async function fetchCityList() {
            try {
                const response = await fetch('https://beats.squareyards.com/api/SecondaryPortal/getCityList', {
                    method: 'POST',
                    headers: {
                        'api_key': 'uAqGJ6bvNqcqsxh4TXMRHP596adeEMLVomMZywp1U0VHUeHLwHxv5jbe5Aw8',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        fromSource: 'whatsapp',
                        countryId: 1,
                        userType: 'CP'
                    })
                });
                const data = await response.json();
                if (data.status === 1 && data.mastercities && Array.isArray(data.mastercities)) {
                    cityList = data.mastercities.map(city => city.cityName).sort();
                } else {
                    console.error('Failed to fetch city list:', data);
                }
            } catch (error) {
                console.error('Error fetching city list:', error);
            }
        }

        async function sendOtp(number) {
            try {
                const response = await fetch('https://chat-bot2-backend.onrender.com/api/otp/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        countryCode: "91",
                        mobile: number
                    })
                });
                const result = await response.json();
                if (response.status === 200 && result.message === 'OTP sent Successfully on mobile') {
                    state.otpSentTime = Date.now();
                    state.lastOtpSent = Date.now();
                    state.otpAttempts = 0;
                    state.isOtpSent = true;
                    return true;
                }
                return false;
            } catch (error) {
                console.error('Error sending OTP:', error);
                return false;
            }
        }

        async function verifyOtp(number, otp) {
            try {
                const response = await fetch('https://chat-bot2-backend.onrender.com/api/otp/verify', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify({
                        countryCode: "91",
                        mobile: number,
                        otp: otp
                    })
                });
                const result = await response.json();
                console.log('OTP Verify Response:', { status: response.status, body: result }); // Detailed logging
                if (response.status === 200 && result.data && result.data.userExists === true) {
                    console.log('OTP Verification Successful:', result.data);
                    return true;
                } else {
                    const errorMessage = result.message || `Verification failed (Status: ${response.status})`;
                    console.error('OTP Verification Failed:', errorMessage);
                    throw new Error(errorMessage);
                }
            } catch (error) {
                console.error('Error verifying OTP:', error.message);
                throw error;
            }
        }

        async function handleTextInput(value, field, validate, errorDiv) {
            const error = validate ? validate(value) : '';
            if (error) {
                errorDiv.textContent = error;
                return;
            }
            clearReminderTimeout();
            state.data[field] = value;

            if (field === 'otp') {
                if (state.otpAttempts >= state.maxOtpAttempts) {
                    errorDiv.textContent = 'Maximum OTP attempts reached. Please resend OTP.';
                    console.warn('Max OTP attempts reached:', state.otpAttempts);
                    return;
                }
                if (Date.now() - state.otpSentTime > state.otpValidDuration) {
                    errorDiv.textContent = 'OTP has expired. Please resend OTP.';
                    console.warn('OTP expired:', { sentTime: state.otpSentTime, currentTime: Date.now() });
                    return;
                }
                state.otpAttempts++;
                showTypingIndicator();
                try {
                    const success = await verifyOtp(state.data.number, value);
                    removeTypingIndicator();
                    if (success) {
                        addUserMessage('****'); // Mask OTP for security
                        addBotMessage('OTP verified successfully.');
                        state.isOtpVerified = true; // Track verification state
                    } else {
                        errorDiv.textContent = `Invalid OTP. ${state.maxOtpAttempts - state.otpAttempts} attempts remaining.`;
                        console.warn('Invalid OTP attempt:', state.otpAttempts);
                        return;
                    }
                } catch (error) {
                    removeTypingIndicator();
                    errorDiv.textContent = `OTP verification failed: ${error.message}`;
                    console.error('Verification error displayed:', error.message);
                    return;
                }
            } else if (field === 'number' && !state.isOtpSent) {
                showTypingIndicator();
                try {
                    const success = await sendOtp(value);
                    removeTypingIndicator();
                    if (!success) {
                        errorDiv.textContent = 'Failed to send OTP. Please try again.';
                        console.warn('OTP send failed');
                        return;
                    }
                    addBotMessage('OTP sent successfully to your phone number.');
                    state.isOtpSent = true;
                } catch (error) {
                    removeTypingIndicator();
                    errorDiv.textContent = `Failed to send OTP: ${error.message}`;
                    console.error('Send OTP error:', error.message);
                    return;
                }
            } else {
                addUserMessage(value);
            }

            if (field === 'number') {
                state.data.user_id = value; // Use phone number as user_id
            }

            proceedToNextStep();
        }

        async function sendChatMessage(message) {
            try {
                const response = await fetch('https://chat-bot2-backend.onrender.com/api/chat', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json',
                        'X-User-Phone': state.data.user_id || 'anonymous' // Send user_id in header
                    },
                    body: JSON.stringify({
                        message: message,
                        city: state.data.city,
                        user_id: state.data.user_id || 'anonymous'
                    })
                });
                const result = await response.json();
                if (response.status === 200 && result.status === 'success') {
                    return result.response;
                } else {
                    throw new Error(result.detail || 'Failed to get response from chatbot.');
                }
            } catch (error) {
                console.error('Error sending chat message:', error);
                return 'Sorry, something went wrong. Please try again.';
            }
        }

        function startOtpTimer(resendButton, timerSpan) {
            let timeLeft = 30;
            timerSpan.textContent = `(Wait ${timeLeft}s)`;
            resendButton.disabled = true;
            resendButton.classList.remove('enabled');

            state.timerInterval = setInterval(() => {
                timeLeft--;
                timerSpan.textContent = `(Wait ${timeLeft}s)`;
                if (timeLeft <= 0) {
                    clearInterval(state.timerInterval);
                    resendButton.disabled = false;
                    resendButton.classList.add('enabled');
                    timerSpan.textContent = '';
                }
            }, 1000);
        }

        chatbotIcon.classList.add('closed');
        startPopupInterval();

        chatbotIcon.addEventListener('click', () => toggleChatbot());
        chatbotIcon.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleChatbot();
            }
        });

        chatbotPopup.addEventListener('click', () => toggleChatbot());
        chatbotPopup.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' || e.key === ' ') {
                e.preventDefault();
                toggleChatbot();
            }
        });

        closeBtn.addEventListener('click', () => {
            chatbotWindow.style.display = 'none';
            chatbotWindow.classList.remove('open');
            clearReminderTimeout();
            clearInterval(state.timerInterval);
            chatbotIcon.classList.remove('open');
            chatbotIcon.classList.add('closed');
            chatbotIcon.focus();
            startPopupInterval();
        });

        function toggleChatbot() {
            const isWindowOpen = chatbotWindow.style.display === 'block';
            if (isWindowOpen) {
                chatbotWindow.style.display = 'none';
                chatbotWindow.classList.remove('open');
                clearReminderTimeout();
                clearInterval(state.timerInterval);
                chatbotIcon.classList.remove('open');
                chatbotIcon.classList.add('closed');
                startPopupInterval();
            } else {
                chatbotWindow.style.display = 'block';
                chatbotWindow.classList.add('open');
                if (!state.hasStarted) {
                    startChat();
                    state.hasStarted = true;
                }
                chatbotIcon.classList.remove('closed');
                chatbotIcon.classList.add('open');
                stopPopupInterval();
                chatbotInput.querySelector('input, button')?.focus();
            }
        }

        async function startChat() {
            // Show first message instantly
            addBotMessage('ðŸ‘‹ Hi! Letâ€™s list your property on SquareYards. ðŸš€');

            // Fetch city list in background
            if (!cityListFetched) {
                fetchCityList().then(() => {
                    cityListFetched = true;
                });
            }

            // Proceed to first step immediately
            showStep(0);
        }

        const steps = [
            {
                message: 'ðŸ‘‹ Welcome to SquareYards! Are you the property owner or an agent? ðŸ§‘â€ðŸ’¼',
                input: 'buttons',
                options: ['Owner', 'Agent'],
                field: 'userType',
                reminder: 'â³ Are you still there? Please choose if youâ€™re an owner or agent.'
            },
            {
                message: 'ðŸ  Is the property for sale or rent? ðŸ’¸',
                input: 'buttons',
                options: ['Sale', 'Rent'],
                field: 'listingType',
                reminder: 'â³ Are you still there? Please select if the property is for sale or rent.'
            },
            {
                message: 'ðŸ“ Which city is your property in? ðŸŒ† (Please select from the dropdown)',
                input: 'text',
                placeholder: 'Type and select city (e.g., Mumbai)',
                field: 'city',
                validate: (value) => {
                    if (value.trim().length === 0) {
                        return 'Please enter a valid city.';
                    }
                    if (!cityList.includes(value)) {
                        return 'Please select a city from the dropdown list.';
                    }
                    return '';
                },
                reminder: 'â³ Are you still there? Please select your city from the dropdown.'
            },
            {
                message: 'âœ¨ To get your property listed quickly and hassle-free, our expert agent is ready to assist you personally! Please share your name (only alphabets, max 20 characters). ðŸ“',
                input: 'text',
                placeholder: 'Enter your full name',
                field: 'name',
                validate: (value) => {
                    if (!/^[a-zA-Z\s]{1,20}$/.test(value)) {
                        return 'Please enter a valid name (only alphabets, max 20 characters).';
                    }
                    return '';
                },
                reminder: 'â³ Are you still there? Please share your name.'
            },
            {
                message: 'ðŸ“ž Please enter your 10-digit phone number to receive an OTP for verification. Your data is secure. ðŸ”’',
                input: 'text',
                placeholder: 'Enter 10-digit phone number',
                field: 'number',
                validate: (value) => /^[0-9]{10}$/.test(value) ? '' : 'Please enter a valid 10-digit phone number.',
                reminder: 'â³ Are you still there? Please enter your phone number.'
            },
            {
                message: 'ðŸ” Please enter the 4-digit OTP sent to your phone number.',
                input: 'otp',
                placeholder: 'Enter OTP',
                field: 'otp',
                validate: (value) => /^[0-9]{4}$/.test(value) ? '' : 'Please enter a valid 4-digit OTP.',
                reminder: 'â³ Are you still there? Please enter the OTP.'
            }
        ];

        function showStep(stepIndex) {
            state.step = stepIndex;
            state.reminderShown = false;
            const step = steps[stepIndex];
            showTypingIndicator();
            setTimeout(() => {
                removeTypingIndicator();
                addBotMessage(step.message);
                setTimeout(() => {
                    chatbotInput.innerHTML = '';
                    clearReminderTimeout();
                    if (stepIndex !== 5) {
                        state.reminderTimeout = setTimeout(() => {
                            if (!state.reminderShown) {
                                addBotMessage(step.reminder, 'reminder-message');
                                state.reminderShown = true;
                            }
                        }, 20000);
                    }

                    if (step.input === 'buttons') {
                        const buttonsDiv = document.createElement('div');
                        buttonsDiv.className = 'buttons';
                        step.options.forEach((option, index) => {
                            const button = document.createElement('button');
                            button.textContent = option;
                            button.setAttribute('aria-label', `Select ${option}`);
                            button.addEventListener('click', () => handleButtonClick(option, step.field));
                            button.className = index === 0 ? 'default' : 'secondary';
                            buttonsDiv.appendChild(button);
                        });
                        chatbotInput.appendChild(buttonsDiv);
                        buttonsDiv.querySelector('button')?.focus();
                    } else if (step.input === 'text') {
                        const inputWrapper = document.createElement('div');
                        inputWrapper.className = 'input-wrapper';

                        const input = document.createElement('input');
                        input.type = step.field === 'number' ? 'tel' : 'text';
                        input.placeholder = step.placeholder;
                        input.setAttribute('aria-label', step.placeholder);
                        input.classList.toggle('dark-mode', chatbotWindow.classList.contains('dark-mode'));
                        if (step.field === 'number') {
                            input.pattern = '[0-9]{10}';
                            input.maxLength = 10;
                        } else if (step.field === 'name') {
                            input.maxLength = 20;
                            input.addEventListener('input', () => {
                                input.value = input.value.replace(/[^a-zA-Z\s]/g, '');
                            });
                        }

                        const submitArrow = document.createElement('span');
                        submitArrow.className = 'submit-arrow';
                        submitArrow.innerHTML = 'âž”';
                        submitArrow.setAttribute('aria-label', 'Submit input');

                        inputWrapper.appendChild(input);
                        inputWrapper.appendChild(submitArrow);

                        chatbotInput.appendChild(inputWrapper);

                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        chatbotInput.appendChild(errorDiv);

                        if (step.field === 'city') {
                            const dropdown = document.createElement('div');
                            dropdown.className = 'autocomplete-dropdown';
                            inputWrapper.appendChild(dropdown);

                            let activeIndex = -1;

                            const debouncedAutocomplete = debounce((value, dropdown) => {
                                dropdown.innerHTML = '';
                                activeIndex = -1;

                                if (value.length === 0) {
                                    dropdown.style.display = 'none';
                                    dropdown.classList.remove('active');
                                    return;
                                }

                                const filteredCities = cityList.filter(city =>
                                    city.toLowerCase().startsWith(value.toLowerCase())
                                );

                                if (filteredCities.length > 0) {
                                    filteredCities.slice(0, 5).forEach((city, index) => {
                                        const item = document.createElement('div');
                                        item.className = 'autocomplete-item';
                                        item.textContent = city;
                                        item.setAttribute('tabindex', '0');
                                        item.setAttribute('role', 'option');
                                        item.addEventListener('click', () => {
                                            input.value = city;
                                            dropdown.innerHTML = '';
                                            dropdown.style.display = 'none';
                                            dropdown.classList.remove('active');
                                            handleTextInput(city, step.field, step.validate, errorDiv);
                                        });
                                        item.addEventListener('keydown', (e) => {
                                            if (e.key === 'Enter') {
                                                input.value = city;
                                                dropdown.innerHTML = '';
                                                dropdown.style.display = 'none';
                                                dropdown.classList.remove('active');
                                                handleTextInput(city, step.field, step.validate, errorDiv);
                                            }
                                        });
                                        dropdown.appendChild(item);
                                    });
                                    dropdown.style.display = 'block';
                                    dropdown.classList.add('active');
                                } else {
                                    dropdown.style.display = 'none';
                                    dropdown.classList.remove('active');
                                }
                            }, 300);

                            input.addEventListener('input', (e) => {
                                debouncedAutocomplete(e.target.value, dropdown);
                                if (step.validate) {
                                    errorDiv.textContent = step.validate(e.target.value);
                                }
                            });

                            input.addEventListener('keydown', (e) => {
                                const items = dropdown.querySelectorAll('.autocomplete-item');
                                if (items.length === 0) return;

                                if (e.key === 'ArrowDown') {
                                    e.preventDefault();
                                    activeIndex = (activeIndex + 1) % items.length;
                                    updateActiveSuggestion(items, activeIndex);
                                    items[activeIndex].focus();
                                } else if (e.key === 'ArrowUp') {
                                    e.preventDefault();
                                    activeIndex = (activeIndex - 1 + items.length) % items.length;
                                    updateActiveSuggestion(items, activeIndex);
                                    items[activeIndex].focus();
                                } else if (e.key === 'Enter' && activeIndex >= 0) {
                                    e.preventDefault();
                                    input.value = items[activeIndex].textContent;
                                    dropdown.innerHTML = '';
                                    dropdown.style.display = 'none';
                                    dropdown.classList.remove('active');
                                    handleTextInput(input.value, step.field, step.validate, errorDiv);
                                } else if (e.key === 'Enter') {
                                    e.preventDefault();
                                    if (cityList.includes(input.value)) {
                                        dropdown.innerHTML = '';
                                        dropdown.style.display = 'none';
                                        dropdown.classList.remove('active');
                                        handleTextInput(input.value, step.field, step.validate, errorDiv);
                                    } else {
                                        errorDiv.textContent = 'Please select a city from the dropdown list.';
                                    }
                                } else if (e.key === 'Escape') {
                                    dropdown.innerHTML = '';
                                    dropdown.style.display = 'none';
                                    dropdown.classList.remove('active');
                                }
                            });

                            submitArrow.addEventListener('click', () => {
                                if (cityList.includes(input.value)) {
                                    dropdown.innerHTML = '';
                                    dropdown.style.display = 'none';
                                    dropdown.classList.remove('active');
                                    handleTextInput(input.value, step.field, step.validate, errorDiv);
                                } else {
                                    errorDiv.textContent = 'Please select a city from the dropdown list.';
                                }
                            });

                            document.addEventListener('click', (e) => {
                                if (!inputWrapper.contains(e.target)) {
                                    dropdown.innerHTML = '';
                                    dropdown.style.display = 'none';
                                    dropdown.classList.remove('active');
                                }
                            });

                            function updateActiveSuggestion(items, index) {
                                items.forEach(item => item.classList.remove('active'));
                                items[index].classList.add('active');
                                items[index].scrollIntoView({ block: 'nearest' });
                            }
                        } else {
                            input.addEventListener('input', () => {
                                if (step.validate) {
                                    errorDiv.textContent = step.validate(input.value);
                                }
                            });
                            input.addEventListener('keypress', (e) => {
                                if (e.key === 'Enter') {
                                    handleTextInput(input.value, step.field, step.validate, errorDiv);
                                }
                            });
                            submitArrow.addEventListener('click', () => {
                                handleTextInput(input.value, step.field, step.validate, errorDiv);
                            });
                        }

                        input.focus();
                    } else if (step.input === 'otp') {
                        const otpContainer = document.createElement('div');
                        otpContainer.className = 'otp-container';

                        const inputs = [];
                        for (let i = 0; i < 4; i++) {
                            const input = document.createElement('input');
                            input.type = 'text';
                            input.className = 'otp-input';
                            input.maxLength = 1;
                            input.pattern = '[0-9]';
                            input.setAttribute('aria-label', `OTP digit ${i + 1}`);
                            input.classList.toggle('dark-mode', chatbotWindow.classList.contains('dark-mode'));
                            otpContainer.appendChild(input);
                            inputs.push(input);
                        }

                        const errorDiv = document.createElement('div');
                        errorDiv.className = 'error-message';
                        chatbotInput.appendChild(otpContainer);
                        chatbotInput.appendChild(errorDiv);

                        const resendDiv = document.createElement('div');
                        resendDiv.className = 'otp-resend';
                        const resendButton = document.createElement('button');
                        resendButton.textContent = 'Resend OTP';
                        const timerSpan = document.createElement('span');
                        timerSpan.className = 'otp-timer';
                        timerSpan.classList.toggle('dark-mode', chatbotWindow.classList.contains('dark-mode'));
                        resendDiv.appendChild(timerSpan);
                        resendDiv.appendChild(resendButton);
                        chatbotInput.appendChild(resendDiv);

                        startOtpTimer(resendButton, timerSpan);

                        resendButton.addEventListener('click', async () => {
                            if (resendButton.disabled) {
                                errorDiv.textContent = 'Please wait before resending OTP.';
                                return;
                            }
                            showTypingIndicator();
                            const success = await sendOtp(state.data.number);
                            removeTypingIndicator();
                            if (success) {
                                addBotMessage('OTP resent successfully.');
                                startOtpTimer(resendButton, timerSpan);
                            } else {
                                errorDiv.textContent = 'Failed to resend OTP. Please try again.';
                            }
                        });

                        inputs.forEach((input, index) => {
                            input.addEventListener('input', () => {
                                if (input.value.length === 1 && index < 3) {
                                    inputs[index + 1].focus();
                                }
                                const otp = inputs.map(inp => inp.value).join('');
                                if (otp.length === 4) {
                                    clearInterval(state.timerInterval);
                                    timerSpan.textContent = '';
                                    handleTextInput(otp, step.field, step.validate, errorDiv);
                                }
                            });
                            input.addEventListener('keydown', (e) => {
                                if (e.key === 'Backspace' && input.value === '' && index > 0) {
                                    inputs[index - 1].focus();
                                }
                            });
                        });

                        inputs[0].focus();
                    }
                }, 300);
            }, 800);
        }

        function clearReminderTimeout() {
            if (state.reminderTimeout) {
                clearTimeout(state.reminderTimeout);
                state.reminderTimeout = null;
            }
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = `message typing-indicator ${currentAnimationStyle}`;
            indicator.setAttribute('aria-hidden', 'true');
            indicator.innerHTML = '<span class="dot"></span><span class="dot"></span><span class="dot"></span>';
            if (chatbotWindow.classList.contains('dark-mode')) {
                indicator.classList.add('dark-mode');
            }
            chatbotBody.appendChild(indicator);
            chatbotBody.scrollTop = chatbotBody.scrollHeight;
        }

        function removeTypingIndicator() {
            const indicator = chatbotBody.querySelector('.typing-indicator');
            if (indicator) {
                indicator.remove();
            }
        }

        function addBotMessage(htmlContent, className = 'bot-message') {
            const message = document.createElement('div');
            message.className = `message ${className}`;
            if (chatbotWindow.classList.contains('dark-mode')) {
                message.classList.add('dark-mode');
            }
            message.innerHTML = htmlContent;
            chatbotBody.appendChild(message);
            chatbotBody.scrollTop = chatbotBody.scrollHeight;
        }

        function addUserMessage(text, isSelectedOption = false) {
            const message = document.createElement('div');
            message.className = 'message user-message';
            if (isSelectedOption) {
                message.classList.add('selected-option');
            }
            message.textContent = text;
            chatbotBody.appendChild(message);
            chatbotBody.scrollTop = chatbotBody.scrollHeight;
        }

        async function handleButtonClick(value, field) {
            clearReminderTimeout();
            state.data[field] = value;
            addUserMessage(value, true);
            proceedToNextStep();
        }

        async function handleTextInput(value, field, validate, errorDiv) {
            const error = validate ? validate(value) : '';
            if (error) {
                errorDiv.textContent = error;
                return;
            }
            clearReminderTimeout();
            state.data[field] = value;

            if (field === 'otp') {
                if (state.otpAttempts >= state.maxOtpAttempts) {
                    errorDiv.textContent = 'Maximum OTP attempts reached. Please resend OTP.';
                    return;
                }
                if (Date.now() - state.otpSentTime > state.otpValidDuration) {
                    errorDiv.textContent = 'OTP has expired. Please resend OTP.';
                    return;
                }
                state.otpAttempts++;
                showTypingIndicator();
                const success = await verifyOtp(state.data.number, value);
                removeTypingIndicator();
                if (!success) {
                    errorDiv.textContent = `Invalid OTP. ${state.maxOtpAttempts - state.otpAttempts} attempts remaining.`;
                    return;
                }
                addUserMessage('****');
            } else {
                addUserMessage(value);
            }

            if (field === 'number' && !state.isOtpSent) {
                showTypingIndicator();
                const success = await sendOtp(value);
                removeTypingIndicator();
                if (!success) {
                    errorDiv.textContent = 'Failed to send OTP. Please try again.';
                    return;
                }
                addBotMessage('OTP sent successfully to your phone number.');
                state.isOtpSent = true;
            }

            const input = chatbotInput.querySelector('input');
            if (input) input.value = '';
            const otpInputs = chatbotInput.querySelectorAll('.otp-input');
            if (otpInputs.length > 0) otpInputs.forEach(inp => inp.value = '');

            // Send user_id with chat requests after number is provided
            if (field === 'number') {
                state.data.user_id = value; // Use phone number as user_id
            }

            proceedToNextStep();
        }

        function proceedToNextStep() {
            if (state.step < steps.length - 1) {
                setTimeout(() => showStep(state.step + 1), 500);
            } else {
                clearReminderTimeout();
                clearInterval(state.timerInterval);
                submitToBackend();
            }
        }

        function showChatInput() {
            chatbotInput.innerHTML = '';
            const inputWrapper = document.createElement('div');
            inputWrapper.className = 'input-wrapper';

            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'Ask about properties...';
            input.setAttribute('aria-label', 'Ask about properties');
            input.classList.toggle('dark-mode', chatbotWindow.classList.contains('dark-mode'));

            const submitArrow = document.createElement('span');
            submitArrow.className = 'submit-arrow';
            submitArrow.innerHTML = 'âž”';
            submitArrow.setAttribute('aria-label', 'Send message');

            inputWrapper.appendChild(input);
            inputWrapper.appendChild(submitArrow);

            chatbotInput.appendChild(inputWrapper);

            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            chatbotInput.appendChild(errorDiv);

            const clearChatBtn = document.createElement('button');
            clearChatBtn.className = 'clear-chat-btn';
            clearChatBtn.textContent = 'Clear Chat & Start New Listing';
            clearChatBtn.setAttribute('aria-label', 'Clear chat and start new listing');
            clearChatBtn.addEventListener('click', clearChat);
            chatbotInput.appendChild(clearChatBtn);

            input.addEventListener('keypress', async (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    const message = input.value.trim();
                    addUserMessage(message);
                    input.value = '';
                    showTypingIndicator();
                    const response = await sendChatMessage(message);
                    removeTypingIndicator();
                    addBotMessage(response);
                }
            });

            submitArrow.addEventListener('click', async () => {
                if (input.value.trim()) {
                    const message = input.value.trim();
                    addUserMessage(message);
                    input.value = '';
                    showTypingIndicator();
                    const response = await sendChatMessage(message);
                    removeTypingIndicator();
                    addBotMessage(response);
                }
            });

            input.focus();
        }

        async function submitToBackend() {
            try {
                const response = await fetch('https://chat-bot2-backend.onrender.com/submit', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Accept': 'application/json'
                    },
                    body: JSON.stringify(state.data)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    state.isLeadSubmitted = true;
                    showTypingIndicator();
                    setTimeout(() => {
                        removeTypingIndicator();
                        addBotMessage(`Thank you, ${state.data.name}! Your phone number has been verified. Our agent will contact you soon to list your property in ${state.data.city}. ðŸ™Œ`);
                        addBotMessage(`
                            <div class="online-status">
                                <span class="online-dot"></span>
                                <span>Agent Online</span>
                            </div>
                            <div class="final-message-container">
                                <img src="https://png.pngtree.com/png-vector/20220702/ourmid/pngtree-customer-service-agent-help-call-png-image_5552034.png?ixlib=rb-4.0.3&auto=format,fit=crop&w=40&h=40&q=80" alt="Agent" class="agent-image">
                                <div class="final-message-text">
                                    ðŸ“ž Our expert agent will call you soon to list your property in ${state.data.city} ðŸ  â€“ get started with SquareYards today! âœ…
                                </div>
                            </div>
                        `);
                        addBotMessage('Feel free to ask any questions about properties or real estate in your city!');
                        showChatInput();
                    }, 800);
                } else {
                    addBotMessage('Sorry, something went wrong. Please try again.');
                }
            } catch (error) {
                console.error('Fetch error:', error);
                addBotMessage('Error connecting to the server. Please try again later.');
            }
        }

        function clearChat() {
            state.step = 0;
            state.data = {
                userType: '',
                listingType: '',
                city: '',
                name: '',
                number: '',
                otp: ''
            };
            state.hasStarted = false;
            state.reminderTimeout = null;
            state.reminderShown = false;
            state.isOtpSent = false;
            state.otpAttempts = 0;
            state.otpSentTime = null;
            state.lastOtpSent = null;
            state.isLeadSubmitted = false;
            clearReminderTimeout();
            clearInterval(state.timerInterval);
            chatbotBody.innerHTML = '';
            chatbotInput.innerHTML = '';
            startChat();
        }
    </script>
</body>
</html>